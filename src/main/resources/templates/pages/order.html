<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:fragment="orderPageFragment ('myInfo', 'addressInfos', 'createOrderRequest', 'packages')">
<head>
    <meta charset="UTF-8"/>
    <!--  <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.tosspayments.com/v1/payment-widget;">-->
    <style>
        #addressFields {
            display: none; /* 주소 입력 필드들을 초기에는 숨김 */
        }
    </style>
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <title></title>
</head>
<body>
<!-- Spinner Start -->
<div
        id="spinner"
        class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50 d-flex align-items-center justify-content-center"
>
    <div class="spinner-grow text-primary" role="status"></div>
</div>
<!-- Spinner End -->
<!-- Navbar Start -->
<div th:replace="~{components/navbar :: navbarFragment}"></div>
<!-- Navbar End -->
<form method="post" enctype="multipart/form-data" th:action="@{/confirm}" th:object="${createOrderRequest}">
    주문
    <br>

    <div th:each="createOrderDetailRequest : ${createOrderRequest.details}" class="item">
        상품 확인
        <!--              상품 이미지 <br> <img th:src="${createOrderDetailRequest.product.thumbnailPath}" alt="Product Image"-->
        <!--                               style="width: 100px; height: auto;"/>-->
        <br>
        <label type="hidden" th:text="${createOrderDetailRequest.orderId}"></label>
        <label type="hidden" th:text="${createOrderDetailRequest.orderStatusId}"></label>
        상품 코드 <label th:text="${createOrderDetailRequest.productId}"></label><br>
        상품 가격 <label th:name="data-price" th:data-price="${createOrderDetailRequest.price}"></label><br>
        상품 수량 <label th:name="data-quantity" th:data-quantity="${createOrderDetailRequest.quantity}"></label><br>
        <!--      상품 출고일 <label th:text="${createOrderDetailRequest.forwardDate}"></label><br>-->
        포장 :
        <input type="radio" id="unpacked" name="wrappingOption" th:field="${createOrderDetailRequest.wrap}"
               th:value="false">
        <label for="unpacked">안함</label>
        <input type="radio" id="wrapping" name="wrappingOption" th:field="${createOrderDetailRequest.wrappingId}">
        <label for="wrapping">포장</label>

        <div id="packagingDropdown" style="display:none;">
            <label for="packages">Select Packaging:</label>
            <select id="packages" th:each="package: ${packages}" name="packages">
                <option th:name="package" th:text="${package.paper}" th:value="${package.id}"></option>
            </select>
        </div>

    </div>
    <br>
    <div type="hidden" th:id="order-delivery-policy" th:field="${createOrderRequest.deliveryPolicyId}"></div>
    <div type="hidden" th:id="order-user-id" th:field="${createOrderRequest.userInfo.loginId}"></div>
    <div>
        총 가격: <input type="text" id="total-price" th:name="${createOrderRequest.price}"
                     th:field="${createOrderRequest.price}" readonly/>
    </div>
    <br>
    주문 고객
    <br>
    이름 : <input type="text" id="order-name" th:field="${myInfo.name}" required/>
    <br>
    휴대폰 : <input type="text" id="order-phone-number" th:field="${myInfo.contactNumber}" required/>
    <br>
    이메일 : <input type="text" id="order-email" th:field="${myInfo.email}" required/>
    <br>
    <br>

    배송 주소
    <br>
    <br>

    수신자 : <input type="text" th:field="${createOrderRequest.receiver}"/>
    <br>
    배송지 :
    <input type="radio" id="addressBook" name="addressOption" value="AddressBook">
    <label for="addressBook">주소록</label>
    <input type="radio" id="newAddress" name="addressOption" value="NewAddress">
    <label for="newAddress">새로입력</label>

    <div id="addressDropdown" style="display:none;">
        <label for="addresses">Select Address:</label>
        <select id="addresses" th:each="address: ${addressInfos}" name="addresses">
            <option th:name="address" th:value="${address.id}" th:text="${address.addressName}">
                <!-- addressName 에 따라 값 가져오기 th:field="${createOrderRequest.address}"-->
            </option>
        </select>
    </div>
    <br>
    <div id="addressFields">
        <br>
        주소 : <input type="text" th:field="${createOrderRequest.address}"/>
        <br>
        상세 주소 : <input type="text" th:field="${createOrderRequest.addressDetail}"/>
        <br>
        휴대폰 : <input type="text" th:field="${myInfo.contactNumber}"/>
    </div>
    <br>
    배송일 선택 :

    <div>
        <input type="radio" id="tomorrow" name="delivery-date" th:value="${createOrderRequest.desiredDeliveryDate}">
        <label for="tomorrow" id="label-tomorrow"></label>
    </div>
    <div>
        <input type="radio" id="dayAfterTomorrow" name="delivery-date" required>
        <label for="dayAfterTomorrow" id="label-dayAfterTomorrow"></label>
    </div>
    <div>
        <input type="radio" id="threeDaysLater" name="delivery-date" required>
        <label for="threeDaysLater" id="label-threeDaysLater"></label>
    </div>
    <br>
    택배사 직원에게 : <input type="text" th:field="${createOrderRequest.request}"/>
    <br>

    <br>

    총 상품금액 : <input type="text" id="total-product-price" th:name="total-product-price" readonly/>

    <br>
    쿠폰 : <input type="text" id="coupon-amount" value="0"/>
    <br>
    차감 포인트 : <input type="text" id="points-deducted" value="0"/>

    <!--  사용 가능 포인트 : <input type="text" th:field="${myInfo.point}" readonly/>-->
    <br>
    최종 결제금액 : <input type="text" id="discount-price" th:name="price" th:field="${createOrderRequest.price}" readonly/>

    <!-- 결제 UI -->
    <div id="payment-method"></div>
    <!-- 이용약관 UI -->
    <div id="agreement"></div>
    <!-- 결제하기 버튼 -->
    <button type="submit" id="payment-button" class="button">결제하기</button>
    <a th:href="@{/cart}">취소</a>
</form>
</body>
<script type="text/javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        function toggleAddress() {
            const addressFields = document.getElementById('addressFields');
            const addressDropdown = document.getElementById('addressDropdown');
            const newAddressRadio = document.getElementById('newAddress');
            const addressBookRadio = document.getElementById('addressBook');

            if (newAddressRadio.checked) {
                addressFields.style.display = 'block';
                addressDropdown.style.display = 'none';
            } else if (addressBookRadio.checked) {
                addressFields.style.display = 'none';
                addressDropdown.style.display = 'block';
            }
        }

        document.querySelectorAll('input[name="addressOption"]').forEach(function (radio) {
            radio.addEventListener('change', toggleAddress);
        });

        toggleAddress();
    });

    document.addEventListener('DOMContentLoaded', function () {
        function toggleWrappingDropdown() {
            const packageRadio = document.getElementById('wrapping');
            const packagingDropdown = document.getElementById('packagingDropdown');

            if (packageRadio.checked) {
                packagingDropdown.style.display = 'block';
            } else {
                packagingDropdown.style.display = 'none';
            }
        }

        document.querySelectorAll('input[name="wrappingOption"]').forEach(function (radio) {
            radio.addEventListener('change', toggleWrappingDropdown);
        });

        toggleWrappingDropdown();
    });

    document.addEventListener('DOMContentLoaded', function () {
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const today = new Date();
        const tomorrow = new Date(today);
        const dayAfterTomorrow = new Date(today);
        const threeDaysLater = new Date(today);

        tomorrow.setDate(today.getDate() + 1);
        dayAfterTomorrow.setDate(today.getDate() + 2);
        threeDaysLater.setDate(today.getDate() + 3);

        document.getElementById('tomorrow').value = formatDate(tomorrow);
        document.getElementById('dayAfterTomorrow').value = formatDate(dayAfterTomorrow);
        document.getElementById('threeDaysLater').value = formatDate(threeDaysLater);

        document.getElementById('label-tomorrow').textContent = `내일 (${formatDate(tomorrow)})`;
        document.getElementById('label-dayAfterTomorrow').textContent = `모레 (${formatDate(dayAfterTomorrow)})`;
        document.getElementById('label-threeDaysLater').textContent = `글피 (${formatDate(threeDaysLater)})`;
    });

    document.addEventListener('DOMContentLoaded', function () {
        let totalPrice = 0;
        document.querySelectorAll('.item').forEach(function (item) {
            const price = parseFloat(item.getAttribute('data-price'));
            const quantity = parseInt(item.getAttribute('data-quantity'));
            totalPrice += price * quantity;
        });

        function updateTotalPrices() {
            document.getElementById('total-price').value = totalPrice.toLocaleString();
            document.getElementById('total-product-price').value = totalPrice.toLocaleString();
        }

        updateTotalPrices();

        function updateFinalPrice() {
            const couponAmount = parseFloat(document.getElementById('coupon-amount').value) || 0;
            const pointsDeducted = parseFloat(document.getElementById('points-deducted').value) || 0;
            const finalPrice = totalPrice - couponAmount - pointsDeducted;
            document.getElementById('discount-price').value = finalPrice.toLocaleString();
        }

        document.getElementById('coupon-amount').addEventListener('input', updateFinalPrice);
        document.getElementById('points-deducted').addEventListener('input', updateFinalPrice);

        updateFinalPrice();
    });

    const button = document.getElementById("payment-button");
    const generateRandomString = () => window.btoa(Math.random()).slice(0, 20);
    const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm"; // 노출
    const customerKey = generateRandomString();
    const paymentWidget = PaymentWidget(clientKey, customerKey);

    const finalPrice = parseFloat(document.getElementById('discount-price').value.replace(/,/g, ''));

    const paymentMethodWidget = paymentWidget.renderPaymentMethods(
        "#payment-method",
        {value: finalPrice},
        {variantKey: "DEFAULT"}
    );

    paymentWidget.renderAgreement("#agreement", {variantKey: "AGREEMENT"});

    paymentMethodWidget.on("ready", function () {
        button.disabled = false;
    });

    button.addEventListener("click", function (event) {
        event.preventDefault();

        paymentWidget.requestPayment({
            orderId: generateRandomString(),
            orderName: "버즈북",
            successUrl: window.location.origin + "/success",
            failUrl: window.location.origin + "/fail",
            customerEmail: document.getElementById('order-email').value,
            customerName: document.getElementById('order-name').value,
            customerMobilePhone: document.getElementById('order-phone-number').value,
        });

    });
    /*]]>*/
</script>
</html>
