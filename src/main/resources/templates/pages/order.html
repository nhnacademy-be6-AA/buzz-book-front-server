<body th:fragment="orderPageFragment ('myInfo', 'addressInfos', 'createOrderRequest', 'packages', 'policies', 'myPoint', 'myCoupons')">

<div class="py-5"></div>
<form method="post" id="order-info" enctype="multipart/form-data">
    <br>
    주문
    <div th:each="createOrderDetailRequest, createOrderDetailRequestStat : ${createOrderRequest.details}" class="item">
        <br>
        <img id="thumbnailPath" th:src="${createOrderDetailRequest.thumbnailPath}" alt="Product Image"
             style="width: 100px; height: auto;"/>
        <div type="hidden" id="orderId" th:if="${not #strings.isEmpty(createOrderDetailRequest.orderId)}"
             th:value="${createOrderDetailRequest.orderId}"></div>
        <div type="hidden" id="orderStatusId" th:value="${createOrderDetailRequest.orderStatusId}"></div>

        <input th:id="'productId-' + ${createOrderDetailRequestStat.index}"
               th:name="'productId-' + ${createOrderDetailRequestStat.index}" type="hidden"
               th:value="${createOrderDetailRequest.productId}" readonly/><br>

        상품 이름 <input th:id="'dataName-' + ${createOrderDetailRequestStat.index}"
                     th:name="'dataName-' + ${createOrderDetailRequestStat.index}"
                     th:value="${createOrderDetailRequest.productName}" readonly/><br>
        상품 가격 <input th:id="'dataPrice-'+ ${createOrderDetailRequestStat.index}"
                     th:name="'dataPrice-'+ ${createOrderDetailRequestStat.index}"
                     th:value="${createOrderDetailRequest.price}" readonly/><br>
        상품 수량 <input th:id="'dataQuantity-'+ ${createOrderDetailRequestStat.index}"
                     th:name="'dataQuantity-'+ ${createOrderDetailRequestStat.index}"
                     th:value="${createOrderDetailRequest.quantity}"
                     readonly/><br>
        포장 :

        <input type="radio" th:id="'unpacked-' + ${createOrderDetailRequestStat.index}"
               th:name="'packing-' + ${createOrderDetailRequestStat.index}" value="false">
        <label th:for="'unpacked-' + ${createOrderDetailRequestStat.index}">안함</label>
        <input type="radio" th:id="'wrapping-' + ${createOrderDetailRequestStat.index}"
               th:name="'packing-' + ${createOrderDetailRequestStat.index}" value=1>
        <label th:for="'wrapping-' + ${createOrderDetailRequestStat.index}">포장</label>
        <div th:id="'packagingDropdown-' + ${createOrderDetailRequestStat.index}" style="display:none;">
            <label th:for="'packages-' + ${createOrderDetailRequestStat.index}">Select Packaging:
                <select th:id="'packages-' + ${createOrderDetailRequestStat.index}"
                        th:name="'packages-' + ${createOrderDetailRequestStat.index}">
                    <option th:value=0>선택하기</option>
                    <option th:each="package : ${packages}" th:value="${package.id}"
                            th:attr="data-package-price=${package.price}"
                            th:text="${package.paper} + ' (' + ${package.price} + '원)'"></option>
                </select>
            </label>
        </div>

    </div>
    <br/>
    <br/>
    <label for="policies">정책 선택:</label>
    <select id="policies" name="policies">
        <option th:each="policy : ${policies}" th:value="${policy.id}" th:text="${policy.name}">
        </option>
    </select>

    <br/>
    <br>
    <input type="hidden" id="orderStr" th:value="${createOrderRequest.orderStr}"
           th:field="${createOrderRequest.orderStr}"/>
    <div>
        총 가격: <input type="text" id="totalPrice" readonly/>
    </div>
    <br>

    주문 고객
    <br>
    이름 : <input type="text" id="order-name"/>
    <input type="hidden" id="order-loginId" th:field="${createOrderRequest.loginId}"/>
    <br>
    휴대폰 : <input type="text" id="order-phone-number" th:field="${createOrderRequest.contactNumber}"/>
    <br>

    이메일 : <input type="text" id="order-email" th:field="${createOrderRequest.orderEmail}"/>

    <br/>

    발신자 : <input id="sender" type="text" th:field="${createOrderRequest.sender}"/>
    <br>

    수신자 : <input id="receiver" type="text" th:field="${createOrderRequest.receiver}"/>
    <br>
    수신자 전화번호 : <input id="receiverContactNumber" type="text" th:field="${createOrderRequest.receiverContactNumber}"/>
    <br>
    <br>
    배송 주소

    <br>
    <div th:if="${not #strings.isEmpty(myInfo.name)}">
        배송지 :
        <input type="radio" id="addressBook" name="addressOption" value="AddressBook">
        <label for="addressBook">주소록</label>
        <input type="radio" id="newAddress" name="addressOption" value="NewAddress">
        <label for="newAddress">새로입력</label>

        <div id="addressDropdown" style="display:none;">
            <label for="addresses">Select Address:</label>
            <select id="addresses" name="addresses">
                <option th:value=0>선택하기</option>
                <option th:each="address : ${addressInfos}"
                        th:value="${address.id}"
                        th:text="${address.alias}">
                </option>
            </select>

        </div>
        <br>
        <div id="addressFields">
            <br>
            주소 : <input type="text" th:field="${createOrderRequest.address}"/>
            <br>
            상세 주소 : <input type="text" th:field="${createOrderRequest.addressDetail}"/>
            <br>
            휴대폰 : <input type="text" th:field="${myInfo.contactNumber}"/>
            <br/>
            우편번호 : <input id="zipcode" type="text" th:field="${createOrderRequest.zipcode}"/>
        </div>
    </div>

    <div th:if="${#strings.isEmpty(myInfo.name)}">
        <br>
        주소 : <input type="text" th:field="${createOrderRequest.address}"/>
        <br>
        상세 주소 : <input type="text" th:field="${createOrderRequest.addressDetail}"/>
    </div>

    <br/>
    배송일 선택 :
    <div>
        <input type="radio" id="tomorrow" name="deliveryDate">
        <label for="tomorrow" id="label-tomorrow"></label>
    </div>
    <div>
        <input type="radio" id="dayAfterTomorrow" name="deliveryDate" required>
        <label for="dayAfterTomorrow" id="label-dayAfterTomorrow"></label>
    </div>
    <div>
        <input type="radio" id="threeDaysLater" name="deliveryDate" required>
        <label for="threeDaysLater" id="label-threeDaysLater"></label>
    </div>
    <br>
    택배사 직원에게 : <input type="text" th:field="${createOrderRequest.request}"/>
    <br>

    <br>

    총 상품금액 : <input type="text" id="totalProductPrice" th:name="totalProductPrice" readonly/>
    <br/>

    <div th:if="${not #strings.isEmpty(myInfo.name)}">
        <br>
        <div id="couponDropdown">
            <label for="coupons">쿠폰 :</label>
            <select id="coupons" name="coupons">
                <option th:value=0>선택하기</option>
                <option th:each="myCoupon : ${myCoupons}"
                        th:value="${myCoupon.couponCode}"
                        th:text="${myCoupon.couponPolicyName}"
                        th:attr="coupon-policy-type=${myCoupon.couponPolicyDiscountType},
                     coupon-policy-amount=${myCoupon.couponPolicyDiscountAmount},
                     coupon-policy-rate=${myCoupon.couponPolicyDiscountRate},
                     coupon-policy-standard-policy=${myCoupon.couponPolicyStandardPrice},
                     coupon-policy-max-discount-amount=${myCoupon.couponPolicyMaxDiscountAmount}">
                </option>
            </select>

        </div>
        <br>
        차감 포인트 : <input type="number" id="pointDeducted" value="0" th:field="${createOrderRequest.myPoint}"/>

        사용 가능 포인트 : <input type="number" id="my-point" th:value="${myPoint}" readonly/>
    </div>

    운임비 : <input type="number" id="deliveryRate" value="0" th:field="${createOrderRequest.deliveryRate}" readonly/>

    <br/>
    최종 결제금액 : <input type="text" id="discountPrice" th:name="price" th:field="${createOrderRequest.price}" readonly/>

    <!-- 결제 UI -->
    <div id="payment-method"></div>
    <!-- 이용약관 UI -->
    <div id="agreement"></div>
    <!-- 결제하기 버튼 -->
    <button type="button" id="payment-button" class="button">결제하기</button>
    <a th:href="@{/cart}">취소</a>
</form>
<script type="text/javascript">

    document.addEventListener('DOMContentLoaded', function () {
        const wrappingRadios = document.querySelectorAll('input[type="radio"][id^="wrapping-"]');

        wrappingRadios.forEach(function (radio) {
            radio.addEventListener('change', function () {
                if (radio.checked) {
                    const index = radio.id.split('-')[1];
                    const unpackedRadio = document.getElementById('unpacked-' + index);
                    if (!unpackedRadio.checked) {
                        unpackedRadio.value = "true";
                    }
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        function toggleAddress() {
            const addressFields = document.getElementById('addressFields');
            const addressDropdown = document.getElementById('addressDropdown');
            const newAddressRadio = document.getElementById('newAddress');
            const addressBookRadio = document.getElementById('addressBook');

            if (newAddressRadio.checked) {
                addressFields.style.display = 'block';
                addressDropdown.style.display = 'none';
            } else if (addressBookRadio.checked) {
                addressFields.style.display = 'none';
                addressDropdown.style.display = 'block';
            }
        }

        document.querySelectorAll('input[name="addressOption"]').forEach(function (radio) {
            radio.addEventListener('change', toggleAddress);
        });

        toggleAddress();
    });

    document.addEventListener('DOMContentLoaded', function () {
        function toggleWrappingDropdown(index) {
            const packageRadio = document.getElementById('wrapping-' + index);
            const packagingDropdown = document.getElementById('packagingDropdown-' + index);

            if (packageRadio.checked) {
                packagingDropdown.style.display = 'block';
            } else {
                packagingDropdown.style.display = 'none';
            }
        }

        document.querySelectorAll('input[id^="wrapping-"]').forEach(function (radio) {
            const index = radio.id.split('-')[1];
            radio.addEventListener('change', function () {
                toggleWrappingDropdown(index);
            });
        });

        document.querySelectorAll('input[id^="unpacked-"]').forEach(function (radio) {
            const index = radio.id.split('-')[1];
            radio.addEventListener('change', function () {
                toggleWrappingDropdown(index);
            });
        });

        document.querySelectorAll('input[id^="wrapping-"]').forEach(function (radio) {
            const index = radio.id.split('-')[1];
            toggleWrappingDropdown(index);
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const today = new Date();
        const tomorrow = new Date(today);
        const dayAfterTomorrow = new Date(today);
        const threeDaysLater = new Date(today);

        tomorrow.setDate(today.getDate() + 1);
        dayAfterTomorrow.setDate(today.getDate() + 2);
        threeDaysLater.setDate(today.getDate() + 3);

        document.getElementById('tomorrow').value = formatDate(tomorrow);
        document.getElementById('dayAfterTomorrow').value = formatDate(dayAfterTomorrow);
        document.getElementById('threeDaysLater').value = formatDate(threeDaysLater);

        document.getElementById('label-tomorrow').textContent = `내일 (${formatDate(tomorrow)})`;
        document.getElementById('label-dayAfterTomorrow').textContent = `모레 (${formatDate(dayAfterTomorrow)})`;
        document.getElementById('label-threeDaysLater').textContent = `글피 (${formatDate(threeDaysLater)})`;

        if (!document.getElementById('tomorrow').checked && !document.getElementById('dayAfterTomorrow').checked && !document.getElementById('threeDaysLater').checked) {
            document.getElementById('tomorrow').checked = true;
        }
    });

    let finalPriceForPay = 0;

    class PriceCalculator {
        constructor() {
            this.totalProductPrice = 0;
            this.packagePrice = 0;
            this.pointsDeducted = parseInt(document.getElementById("pointDeducted").value);
            this.packageSelected = false;
            this.couponAmount = 0;
        }

        calculateTotalProductPrice() {
            this.totalProductPrice = 0;
            document.querySelectorAll('.item').forEach(item => {
                const price = parseInt(item.querySelector('[name^="dataPrice"]').value);
                const quantity = parseInt(item.querySelector('[name^="dataQuantity"]').value);
                this.totalProductPrice += price * quantity;
            });
            return this;
        }

        updateTotalPrices() {
            let totalPrice = this.totalProductPrice + (this.packageSelected ? this.packagePrice : 0) + this.packagePrice;
            document.getElementById('totalPrice').value = totalPrice.toLocaleString();
            document.getElementById('totalProductPrice').value = totalPrice.toLocaleString();
            return this;
        }

        formatNumber(value) {
            return value.toString().replace(/\D/g, "");
        }


        updateFinalPrice() {
            let finalPrice = this.totalProductPrice + (this.packageSelected ? this.packagePrice : 0) + this.packagePrice
                - (this.pointsDeducted ? this.pointsDeducted : 0) - (this.couponAmount ? this.couponAmount : 0);
            document.getElementById('discountPrice').value = finalPrice.toLocaleString();
            finalPriceForPay = this.formatNumber(finalPrice);
            return this;
        }

        updatePackagePrice() {
            let packagePrice = 0;
            const selectElements = document.querySelectorAll('select[id^="packages-"]');

            selectElements.forEach(selectElement => {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                let newPackagePrice = parseInt(selectedOption.getAttribute('data-package-price'));

                if (selectElement.selectedIndex === 0) {
                    newPackagePrice = 0;
                }

                packagePrice += newPackagePrice;
            });

            this.packagePrice = packagePrice;
            this.updateTotalPrices().updateFinalPrice();
            return this;
        }

        resetPackagePrice(index) {
            const unpackedRadio = document.querySelector(`input[type="radio"][id="unpacked-${index}"]`);

            unpackedRadio.value = "false";

            document.querySelector(`select[id="packages-${index}"]`).value = 0;
            this.updatePackagePrice().updateTotalPrices().updateFinalPrice();

            return this;
        }

        checkPointDeduction() {
            const pointDeducted = document.getElementById('pointDeducted');
            const availablePoints = parseInt(document.getElementById('my-point').value);
            const pointDeductedValue = parseInt(pointDeducted.value);

            if (pointDeductedValue > availablePoints) {
                pointDeducted.value = availablePoints;
            } else if (pointDeductedValue < 0 || isNaN(pointDeductedValue)) {
                pointDeducted.value = 0;
            }
        }

        applyCoupon() {
            this.couponAmount = 0;
            const selectedCoupon = document.getElementById('coupons').selectedOptions[0];
            const discountType = selectedCoupon.getAttribute('coupon-policy-type');
            const discountAmount = parseInt(selectedCoupon.getAttribute('coupon-policy-amount'));
            const discountRate = parseFloat(selectedCoupon.getAttribute('coupon-policy-rate'));
            const standardPrice = parseInt(selectedCoupon.getAttribute('coupon-policy-standard-policy'));
            const maxDiscountAmount = parseInt(selectedCoupon.getAttribute('coupon-policy-max-discount-amount'));
            const totalAmount = parseInt(this.formatNumber(document.getElementById('discountPrice').value));
            if (totalAmount >= standardPrice) {
                if (discountType === 'rate') {
                    let discount = totalAmount * (discountRate);
                    if (discount > maxDiscountAmount) {
                        discount = maxDiscountAmount;
                    }
                    this.couponAmount += discount;
                } else if (discountType === 'amount') {
                    this.couponAmount += discountAmount;
                    if (totalAmount < 0) {
                        this.totalProductPrice = 0;
                    }
                }
            }
            this.updateFinalPrice();
        }

        addEventListeners() {
            document.getElementById('coupons').addEventListener('change', () => {
                this.calculateTotalProductPrice().updatePackagePrice().updateTotalPrices();
                this.applyCoupon();
                this.updateFinalPrice();
            });

            document.getElementById('pointDeducted').addEventListener('input', () => {
                this.checkPointDeduction();
                this.pointsDeducted = parseInt(document.getElementById('pointDeducted').value);
                this.updateFinalPrice();
            });

            document.querySelectorAll('select[id^="packages-"]').forEach(select => {
                select.addEventListener('change', () => {
                    const anySelected = Array.from(document.querySelectorAll('select[id^="packages-"]'))
                        .some(selectElement => selectElement.selectedIndex !== 0);

                    if (anySelected) {
                        this.updatePackagePrice();
                    } else {
                        this.packagePrice = 0;
                        this.updateTotalPrices().updateFinalPrice();
                    }
                });
            });

            document.querySelectorAll('input[type="radio"][id^="unpacked-"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.checked) {
                        const index = radio.id.split('-')[1];
                        this.resetPackagePrice(index)
                        this.updatePackagePrice().updateTotalPrices().updateFinalPrice();
                    }
                });
            });

            return this;
        }

        init() {
            this.calculateTotalProductPrice().updatePackagePrice().updateTotalPrices().updateFinalPrice().addEventListeners();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const calculator = new PriceCalculator();
        calculator.init();
    });


    async function post(url, body, contentType, headers = {}) {
        const options = {
            method: "POST",
            headers: {
                'Content-Type': contentType,
                'Accept': 'application/json',
            },
            body: body,
        };

        try {
            const res = await fetch(url, options);

            if (!res.ok) {
                console.error(`HTTP error! status: ${res.status}`);
                return null;
            }
        } catch (error) {
            console.error("Error in post request:", error);
            return null;
        }
    }

    function collectFormData(formElement) {
        const formData = new FormData(formElement);
        const requestData = {};

        formData.forEach((value, key) => {
            const keys = key.split('.');

            if (keys.length > 1) {
                if (!requestData[keys[0]]) {
                    requestData[keys[0]] = {};
                }
                requestData[keys[0]][keys[1]] = value;
            } else {
                requestData[key] = value;
            }
        });

        if (requestData.desiredDeliveryDate) {
            requestData.desiredDeliveryDate = new Date(requestData.desiredDeliveryDate).toISOString();
        }

        return JSON.stringify(requestData).replace(/'/g, '"').replace(/\r/gi, '\\r').replace(/\n/gi, '\\n').replace(/\t/gi, '\\t').replace(/\f/gi, '\\f');
    }

    let requestData;

    function transfer() {
        const formElement = document.getElementById('order-info');
        requestData = collectFormData(formElement);

        console.log("로그 requestData", requestData);

        const obj = JSON.parse(requestData);

        function objectToQueryString(obj) {
            return Object.keys(obj).map(key => `${key}=${obj[key]}`).join('&');
        }

        const queryString = objectToQueryString(obj);
        console.log(queryString)

        return post('/order/register', queryString, 'application/x-www-form-urlencoded');

    }

    const button = document.getElementById("payment-button");
    const generateRandomString = () => window.btoa(Math.random()).slice(0, 20);
    const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm"; // 노출
    const customerKey = generateRandomString();


    const paymentWidget = PaymentWidget(clientKey, customerKey);
    let paymentMethodWidget = paymentWidget.renderPaymentMethods(
        "#payment-method",
        {value: finalPriceForPay},
        {variantKey: "DEFAULT"}
    );

    paymentWidget.renderAgreement("#agreement", {variantKey: "AGREEMENT"});

    paymentMethodWidget.on("ready", function () {
        button.disabled = false;
    });

    button.addEventListener("click", function (event) {
        event.preventDefault();

        const orderStr = generateRandomString();
        document.getElementById('orderStr').value = orderStr;
        try {
            transfer().then(
                data => {
                    paymentMethodWidget = paymentWidget.renderPaymentMethods(
                        "#payment-method",
                        {value: finalPriceForPay},
                        {variantKey: "DEFAULT"}
                    );

                    paymentWidget.requestPayment({
                        orderId: orderStr,
                        orderName: "버즈북",
                        successUrl: window.location.origin + "/success?customerEmail=" + document.getElementById('order-email').value + "&myPoint=" + document.getElementById('pointDeducted').value,
                        failUrl: window.location.origin + "/fail",
                        customerEmail: document.getElementById('order-email').value,
                        customerName: document.getElementById('order-name').value,
                        customerMobilePhone: document.getElementById('order-phone-number').value,
                    });

                }
            );
        } catch (e) {
            console.error(e);
        }
    });

    /*]]>*/
</script>

</body>
